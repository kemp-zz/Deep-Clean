name: Storage Monitor
on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹è‡ªåŠ¨æ‰§è¡Œ
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: read
  actions: read
  packages: read
  id-token: write  # æ–°å¢å®‰å…¨ä»¤ç‰Œæƒé™[7](@ref)

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4  # å‡çº§è‡³æœ€æ–°ç¨³å®šç‰ˆ[6](@ref)

      - name: Setup Core Tools
        run: |
          sudo apt-get update && sudo apt-get install -y bc jq  # ç¡®ä¿ä¾èµ–å·¥å…·å®‰è£…[1](@ref)

      - name: Run Storage Analyzer
        id: storage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åŠ¨æ€è§£æä»“åº“ä¿¡æ¯
          REPO_OWNER=${GITHUB_REPOSITORY%/*}
          REPO_NAME=${GITHUB_REPOSITORY#*/}

          # API è¯·æ±‚å¤´é…ç½®
          API_HEADER=(
            -H "Accept: application/vnd.github+json" 
            -H "Authorization: Bearer $GITHUB_TOKEN"
            -H "X-GitHub-Api-Version: 2022-11-28"
          )

          echo "::group::ğŸ“Š å­˜å‚¨æ•°æ®é‡‡é›†ä¸­..."
          
          # åˆ¶å“æ•°æ®ï¼ˆè‡ªåŠ¨å¤„ç†ç©ºå€¼ï¼‰
          artifacts=$(curl -sSf "${API_HEADER[@]}" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/artifacts")
          artifact_mb=$(echo "$artifacts" | jq -r '[.artifacts[].size_in_bytes //0] | add | . / (1024 * 1024) | floor')MB

          # ç¼“å­˜æ•°æ®ï¼ˆä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢ï¼‰
          cache_usage=$(curl -sSf "${API_HEADER[@]}" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/cache/usage?per_page=100")
          cache_mb=$(echo "$cache_usage" | jq -r '.full_cache_size_in_bytes / (1024 * 1024) | floor')MB

          # å®¹å™¨åŒ…æ•°æ®ï¼ˆç²¾ç¡®è¿‡æ»¤ä»“åº“å½’å±ï¼‰
          packages=$(curl -sSf "${API_HEADER[@]}" \
            "https://api.github.com/orgs/$REPO_OWNER/packages?package_type=container")
          package_mb=$(echo "$packages" | jq -r "[.[] | select(.repository.name == \"$REPO_NAME\") | .size_in_bytes] | add //0 / (1024 * 1024) | floor")MB

          echo "::endgroup::"

          # ç”Ÿæˆå¤šæ ¼å¼æŠ¥å‘Š
          cat <<EOF > storage-report.txt
          â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚ å­˜å‚¨ä½¿ç”¨æŠ¥å‘Š ($(date +%F)) â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚
          âœ… åˆ¶å“å­˜å‚¨ï¼š$artifact_mb (ä¸Šé™ 2GB)
          ğŸ”„ ç¼“å­˜ä½¿ç”¨ï¼š$cache_mb (ä¸Šé™ 10GB)
          ğŸ“¦ å®¹å™¨åŒ…ï¼š$package_mb (ä¸Šé™ 1GB)
          â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚ æ€»ä½¿ç”¨é‡ â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚
          ğŸ“ˆ åˆè®¡ï¼š$(( ${artifact_mb/MB} + ${cache_mb/MB} + ${package_mb/MB} ))MB
          EOF

          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "artifact_mb=$artifact_mb" >> $GITHUB_OUTPUT
          echo "cache_mb=$cache_mb" >> $GITHUB_OUTPUT
          echo "package_mb=$package_mb" >> $GITHUB_OUTPUT

      - name: Upload Report
        uses: actions/upload-artifact@v4  # å‡çº§è‡³ v4 ç‰ˆæœ¬[7](@ref)
        with:
          name: storage-report-${{ github.run_id }}
          path: storage-report.txt
          retention-days: 7  # è®¾ç½®è‡ªåŠ¨æ¸…ç†å‘¨æœŸ[6](@ref)

      - name: Notify Result
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const report = fs.readFileSync('storage-report.txt', 'utf8')
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“£ å­˜å‚¨ç›‘æ§æŠ¥å‘Šï¼š\n\`\`\`\n${report}\n\`\`\``
            })
