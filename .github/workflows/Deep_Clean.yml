name: Deep Clean
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  storage-cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y ncdu jq

      - name: Rotate system logs
        run: |
          sudo journalctl --rotate
          sudo journalctl --vacuum-time=7d
          sudo find /var/log -name "*.gz" -mtime +14 -exec rm -f {} \;
          echo "剩余日志空间: $(df -h /var/log | awk 'NR==2{print $4}')"

      - name: Purge Docker artifacts
        shell: bash
        env:
          DOCKER_CLEAN_FLAG: "aggressive"
        run: |
          sudo systemctl is-active docker || sudo systemctl start docker
          docker system prune -a --volumes --force
          sudo find /var/lib/docker/overlay2 -type f -name "*.tmp" -mtime +3 -delete

      - name: Kernel housekeeping
        continue-on-error: true
        run: |
          current_kernel=$(uname -r | sed 's/-generic//')
          echo "保留内核版本: $current_kernel"
          sudo apt purge -y $(dpkg -l | awk '/linux-image-[0-9]/{print $2}' | grep -v $current_kernel | head -n -2)

      - name: APT repository optimization
        run: |
          sudo apt autoremove --purge -y
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Tempfile sanitation
        run: |
          sudo find /tmp -type f -mtime +7 -exec rm -f {} \;
          sudo find /var/tmp -name "*.un~" -delete

      - name: Android SDK 智能清理
        continue-on-error: true
        run: |
          installed_packages=$(/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --list_installed)
          target_packages=(
            "^build-tools;34\.0\.0$"
            "^platforms;android-33$"
            "^system-images;android-30;google_apis;x86_64$"
          )
          for pkg in "${target_packages[@]}"; do
            if echo "$installed_packages" | grep -Pq "$pkg"; then
              echo "正在卸载：$pkg"
              /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --uninstall "$pkg"
            else
              echo "跳过未安装的包：$pkg"
            fi
          done

      - name: 第三方工具链原子级清理
        run: |
          sudo find /opt/hostedtoolcache -maxdepth 2 \
            $ -name "1.2*" -o -name "node_modules" -o -name "__pycache__" $ \
            -mtime +30 -exec rm -rf {} + 2>/dev/null
          modules=$(npm list -g --depth=0 --parseable | awk -F/ '{print $NF}' | grep -vE '^(npm|corepack)$')
          [[ -n "$modules" ]] && echo "$modules" | xargs sudo npm uninstall -g --no-audit 2>/dev/null

      - name: PIP Ecosystem Sanitization
        run: |
          echo "▂▂▂▂▂▂▂▂ Python 环境清理 ▂▂▂▂▂▂▂▂"
          pip list --user --format=freeze | 
          grep -vE '^(pip|setuptools|wheel)==' | 
          cut -d= -f1 | 
          xargs -r pip uninstall -y

          # 权限修复点：使用sudo清理系统级缓存
          sudo pip cache purge 2>/dev/null || true
          sudo rm -rf ~/.cache/pip ~/.pyenv/versions/* 
          
          # 精确路径匹配（修复原始错误）
          sudo find /usr/local -path "*/__pycache__" -type d -exec rm -rf {} +
          sudo find /usr/local -name "*.pyc" -mtime +7 -delete

      - name: APT Nuclear Cleanup
        run: |
          echo "▂▂▂▂▂▂▂▂ APT 原子级清理 ▂▂▂▂▂▂▂▂"
          sudo dpkg -P google-cloud-sdk azure-cli \
            postgresql-12 openjdk-11-jdk \
            --force-depends
          sudo apt purge -y $(dpkg -l | grep '^rc' | awk '{print $2}')
          sudo dpkg -l 'linux-headers-*' | awk '/^ii/{print $2}' | \
            grep -v $(uname -r | sed 's/-generic//') | xargs sudo apt purge -y

      - name: Enhanced Storage Report
        run: |
          echo "▂▂▂▂▂▂▂▂ 最大目录 TOP10 ▂▂▂▂▂▂▂▂"
          sudo du -h --max-depth=2 / 2>/dev/null | sort -hr | head -10 | awk '
            BEGIN { print "路径                                   ➔ 占用空间" }
            { printf "%-40s ➔ \033[36m%8s\033[0m\n", $2, $1 }'
          
          sudo ncdu -x -o storage.json /
          echo "▂▂▂▂▂▂▂▂ 详细分析 ▂▂▂▂▂▂▂▂"
          jq '[.directories[] | {path: .name, size: (.total_size / (1024 * 1024) | floor)}] | sort_by(-.size) | .[0:5]' storage.json
