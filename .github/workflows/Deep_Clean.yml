name: Deep Clean
on: workflow_dispatch

jobs:
  storage-cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    permissions:
      actions: write
      contents: read

    steps:
      - name: 环境预检
        run: |
          set -euo pipefail
          echo "▂▂▂▂▂▂▂▂ 存储诊断 ▂▂▂▂▂▂▂▂"
          
          declare -a check_paths=(
            "/usr/lib/python3/dist-packages"
            "/usr/local/share/boost"
            "/opt/hostedtoolcache/Python"
            "/var/lib/apt/lists"
          )
          
          for path in "${check_paths[@]}"; do
            if compgen -G "$path" > /dev/null; then
              echo "✅ 有效路径: $(ls -d $path)"
            else
              echo "::warning::路径不存在: $path"
            fi
          done

          echo "▂▂▂▂▂▂▂▂ 初始空间 ▂▂▂▂▂▂▂▂"
          df -h /

      - name: Android SDK 智能清理
        continue-on-error: true
        run: |
          # 动态检测已安装包
          installed_packages=$(/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --list_installed)

          # 正则严格匹配目标包
          target_packages=(
            "^build-tools;34\.0\.0$"
            "^platforms;android-33$"
            "^system-images;android-30;google_apis;x86_64$"
          )

          # 精确卸载存在的包
          for pkg in "${target_packages[@]}"; do
            if echo "$installed_packages" | grep -Pq "$pkg"; then
              echo "正在卸载：$pkg"
              /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --uninstall "$pkg"
            else
              echo "跳过未安装的包：$pkg"
            fi
          done

      - name: 第三方工具链原子级清理
        run: |
          # 修复后的 find 命令
          sudo find /opt/hostedtoolcache -maxdepth 2 \
            \( -name "1.2*" -o -name "node_modules" -o -name "__pycache__" \) \
            -mtime +30 -exec rm -rf {} + 2>/dev/null

          # 安全版 Node 模块卸载
          modules=$(npm list -g --depth=0 --parseable | awk -F/ '{print $NF}' | grep -vE '^(npm|corepack)$')
          if [[ -n "$modules" ]]; then
            echo "$modules" | xargs sudo npm uninstall -g --no-audit 2>/dev/null
          fi

      - name: 清理验证
        run: |
          echo "▂▂▂▂▂▂▂▂ 最终状态 ▂▂▂▂▂▂▂▂"
          df -h / | awk 'NR==2 {printf "总空间: %s ➔ 可用空间: %s\n", $2, $4}'
          
          echo "▂▂▂▂▂▂▂▂ 目录详情 ▂▂▂▂▂▂▂▂"
          sudo du -d 2 -h /opt /usr/local 2>/dev/null | sort -hr | awk '
            BEGIN {print "\033[36m路径\t\t占用空间\033[0m"}
            $2 ~ /(node|Python|jdk)/ {
              printf "%-45s ➔ \033[31m%8s\033[0m\n", $2, $1
              next
            }
            NR<=10 {
              printf "%-45s ➔ \033[32m%8s\033[0m\n", $2, $1
            }'
