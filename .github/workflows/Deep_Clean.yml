name: Deep Clean
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  storage-cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pre-Cleanup Checks
        run: |
          # 验证 sudo 权限和路径存在性 [1](@ref)
          if ! sudo -n true 2>/dev/null; then
            echo "错误：工作流未配置sudo权限" >&2
            exit 1
          fi
          sudo du -sh /usr/local/lib/android/sdk 2>/dev/null || true
          sudo du -sh /var/lib/gems /usr/share/miniconda /usr/lib/google-cloud-sdk 2>/dev/null

      - name: 多路径强制清理
        run: |
          # 清理系统级 SDK [4,5](@ref)
          if [ -d "/usr/local/lib/android/sdk" ]; then
            echo "▂▂▂▂▂▂▂▂ 强制清理系统级 SDK ▂▂▂▂▂▂▂▂"
            sudo rm -rf /usr/local/lib/android/sdk
            sudo sed -i '/ANDROID_HOME/d' /etc/environment
          fi

          # 清理其他指定目录 [1,5](@ref)
          targets=(
            "/var/lib/gems"
            "/usr/share/miniconda"
            "/usr/lib/google-cloud-sdk"
          )
          for dir in "${targets[@]}"; do
            if [ -d "$dir" ]; then
              echo "正在清理 $dir ..."
              sudo rm -rf "$dir"
            fi
          done

      - name: 安装新版 SDK
        run: |
          # 沙盒化安装 SDK [4,11](@ref)
          mkdir -p ~/android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-*.zip -d ~/android-sdk/cmdline-tools
          mv ~/android-sdk/cmdline-tools/cmdline-tools ~/android-sdk/cmdline-tools/latest
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "PATH=$HOME/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

      - name: 接受 Android 许可证
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

      - name: SDK 组件智能清理
        run: |
          # 批量清理未安装组件 [5,7](@ref)
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list --channel=0 | 
            awk '/ndk;.*not installed/{gsub(/"/,"",$1); print $1}' | 
            xargs -r $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall

          # 清理历史版本 [4](@ref)
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall "cmake;*" --include_obsolete

      - name: 存储健康报告
        continue-on-error: true
        run: |
          # 修复 JSON 解析错误 [9](@ref)
          sudo apt-get install -y ncdu jq
          sudo ncdu -x -o storage.json /
          
          echo "▂▂▂▂▂▂▂▂ 存储占用 TOP5 ▂▂▂▂▂▂▂▂"
          jq -r '[.disk_usage.directories[] | 
            select(.name != "/") | 
            {path: .name, size: (.total_size/(1024 * 1024)|floor)}] | 
            sort_by(-.size) | .[0:5] | 
            .[] | "\(.path) ➔ \(.size)MB"' storage.json
