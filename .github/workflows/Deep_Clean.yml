name: Deep Clean
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  storage-cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pre-Cleanup Checks
        run: |
          # 验证 sudo 权限和路径存在性
          if ! sudo -n true 2>/dev/null; then
            echo "错误：工作流未配置sudo权限" >&2
            exit 1
          fi
          sudo du -sh /usr/local/lib/android/sdk 2>/dev/null || true
          ls -ld /opt/hostedtoolcache


      - name: Android SDK 全路径清理
        run: |
          # 系统级 SDK 强制删除（参考网页6[6](@ref)和网页7[7](@ref)）
          if [ -d "/usr/local/lib/android/sdk" ]; then
            echo "▂▂▂▂▂▂▂▂ 强制清理系统级 SDK ▂▂▂▂▂▂▂▂"
            sudo rm -rf /usr/local/lib/android/sdk
            sudo sed -i '/ANDROID_HOME/d' /etc/environment
          fi

          # 安装新版 SDK 工具（兼容 Actions 环境）
          mkdir -p ~/android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-*.zip -d ~/android-sdk/cmdline-tools
          mv ~/android-sdk/cmdline-tools/cmdline-tools ~/android-sdk/cmdline-tools/latest
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "PATH=$HOME/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

      - name: 接受 Android 许可证
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

      - name: SDK 组件智能清理
        run: |
          # 批量卸载未安装的 NDK 版本（参考网页6[6](@ref)）
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list --channel=0 | 
            awk '/ndk;.*not installed/{gsub(/"/,"",$1); print $1}' | 
            xargs -r $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall

          # 清理 CMake 历史版本
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall "cmake;*" --include_obsolete

      - name: 存储健康报告
        continue-on-error: true
        run: |
          sudo apt-get install -y ncdu jq
          sudo ncdu -x -o storage.json /
          
          echo "▂▂▂▂▂▂▂▂ 存储占用 TOP5 ▂▂▂▂▂▂▂▂"
          jq -r '[.disk_usage.directories[] | 
            select(.name != "/") | 
            {path: .name, size: (.total_size/(1024 * 1024)|floor)}] | 
            sort_by(-.size) | .[0:5] | 
            .[] | "\(.path.padEnd(50)) ➔ \(.size)MB"' storage.json
