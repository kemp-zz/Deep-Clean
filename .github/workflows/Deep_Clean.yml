name: Deep Clean
on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  packages: read
  id-token: write  # æ–°å¢å®‰å…¨ä»¤ç‰Œæƒé™[7](@ref)

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Core Tools
        run: sudo apt-get install -y jq bc  # ç¡®ä¿ä¾èµ–å­˜åœ¨

      - name: Run Storage Analyzer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ¶å“æ•°æ®æŸ¥è¯¢ï¼ˆç©ºå€¼ä¼˜åŒ–ï¼‰
          artifacts=$(curl -sSf "${API_HEADER[@]}" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/artifacts")
          artifact_mb=$(echo "$artifacts" | 
            jq -r '[.artifacts[].size_in_bytes //0] | add | ./(1024 * 1024) | floor')MB

          # è¾“å‡ºå˜é‡æ ‡å‡†åŒ–
          {
            echo "artifact_mb<<EOF"
            echo "$artifact_mb"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Notify Result
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('storage-report.txt', 'utf8');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âœ… å­˜å‚¨æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼š\n\`\`\`\n${report}\n\`\`\``
              });
            } catch (error) {
              core.setFailed(`é€šçŸ¥å¤±è´¥: ${error}`);
            }

      - name: Upload Report
        uses: actions/upload-artifact@v4  # å‡çº§è‡³ v4 ç‰ˆæœ¬[7](@ref)
        with:
          name: storage-report-${{ github.run_id }}
          path: storage-report.txt
          retention-days: 7  # è®¾ç½®è‡ªåŠ¨æ¸…ç†å‘¨æœŸ[6](@ref)

      - name: Notify Result
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const report = fs.readFileSync('storage-report.txt', 'utf8')
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“£ å­˜å‚¨ç›‘æ§æŠ¥å‘Šï¼š\n\`\`\`\n${report}\n\`\`\``
            })
